<%- include('partials/header', { title: 'Admin Dashboard' }) %>

<header class="header">
    <h1><span class="logo">üõ°Ô∏è</span>Admin Dashboard</h1>
    <div>
        <a href="/logout" class="btn btn-danger">Logout</a>
        <span id="theme-toggle" class="theme-toggle">üåô</span>
    </div>
</header>

<main class="container">
    <div class="card stats-grid">
        <div class="stat-card">
            <h3>Total Complaints</h3>
            <p class="count"><%= stats.total %></p>
        </div>
        <div class="stat-card">
            <h3>Resolved</h3>
            <p class="count"><%= stats.resolved %></p>
        </div>
        <div class="stat-card">
            <h3>On Progress</h3>
            <p class="count"><%= stats.inProgress %></p>
        </div>
    </div>

    <div class="card">
        <h3>Manage Complaints</h3>
        
        <form action="/admin/dashboard" method="GET" class="filters">
            <div class="form-group">
                <input type="text" name="searchPhone" placeholder="Search by Citizen Phone..." value="<%= filters.searchPhone %>">
            </div>
            <div class="form-group">
                <select name="status">
                    <option value="All" <%= filters.status === 'All' ? 'selected' : '' %>>All Statuses</option>
                    <option value="Sent" <%= filters.status === 'Sent' ? 'selected' : '' %>>Sent</option>
                    <option value="Viewed" <%= filters.status === 'Viewed' ? 'selected' : '' %>>Viewed</option>
                    <option value="On Progress" <%= filters.status === 'On Progress' ? 'selected' : '' %>>On Progress</option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary">Filter</button>
        </form>

        <div class="complaint-table">
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Complaint #</th>
                        <th>Citizen</th>
                        <th>Details</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <% complaints.forEach(c => { %>
                        <tr>
                            <td><span class="time-ago" data-date="<%= c.createdAt.toISOString() %>"></span></td>
                            <td><%= c.complaintNumber %></td>
                            <td><%= c.citizenName %> (<%= c.citizenPhone %>)</td>
                            <td>
                                <strong><%= c.complaintName %></strong> (<%= c.complaintType %>)<br>
                                <small><%= c.address %></small>
                            </td>
                            <td>
                                <span class="complaint-status status-<%= c.status.replace(' ', '.') %>">
                                    <%= c.status %>
                                </span>
                            </td>
                            <td>
                                <form action="/admin/complaint/<%= c._id %>/status" method="POST">
                                    <select name="status" onchange="this.form.submit()">
                                        <option disabled selected>Change Status</option>
                                        <option value="Viewed">Viewed</option>
                                        <option value="On Progress">On Progress</option>
                                        <option value="Resolved">Resolved</option>
                                    </select>
                                </form>
                            </td>
                        </tr>
                    <% }) %>
                </tbody>
            </table>
        </div>
        <br>
        <button id="view-resolved-btn" class="btn btn-primary">View Resolved Complaints</button>
        <div id="resolved-complaints-container" class="hidden"></div>
    </div>
</main>

<%- include('partials/footer') %>